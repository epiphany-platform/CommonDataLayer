name: Test

on:
  push:
    branches:
      - "*"
  pull_request:


jobs:
  component-testing:
    name: Test modules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: install k8s
        run: |
          curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE=777 sh -s - --docker
          cat /etc/rancher/k3s/k3s.yaml
          mkdir -p ~/.kube
          cp /etc/rancher/k3s/k3s.yaml ~/.kube/config

      - name: example tests
        run: |
          kubectl cluster-info
          helm install --values ./deployment/helm/infrastructure/values.yaml infrastructure ./deployment/helm/infrastructure
          DOCKER_BUILDKIT=1 ENV=DEV ./build.sh
          helm install --values ./deployment/helm/cdl/values-local.yaml cdl ./deployment/helm/cdl
          sleep 30
          kubectl get po
          sleep 30
          kubectl get po
          sleep 30
          kubectl get po
          docker ps

